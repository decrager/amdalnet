image: php:7.4-cli

# services:
#   - mysql:5.7

stages:
  # - test
  - dev
  - cloud
  - production

# unit_test:
#   stage: test
#   script:
#     - cp .env.example .env
#     - composer install
#     - php artisan key:generate
#     - php artisan migrate
#     - vendor/bin/phpunit

deploy_dev:
  stage: dev
  script:
    - cd /home/adminhadoop/apps/amdalnet/
    - git reset --hard origin/master
    - git pull
    - docker-compose up -d
    - sudo chown adminhadoop:adminhadoop -R storage/
    - sudo chmod 777 -R storage/
    - docker-compose exec -T laravel composer install
    - docker-compose exec -T laravel composer dump-autoload
    - docker-compose exec -T laravel php artisan migrate
    - docker-compose exec -T laravel npm install
    - docker-compose exec -T laravel npm run production
    # - docker-compose restart laravel
    - echo "Update db cloud"
    #- ssh hadoop@192.168.7.23 'PGPASSWORD=SemangatT3rus pg_dump -h localhost -U amdaldevs -d amdalnet -c --if-exists 
    #- ssh amdalnet@103.172.205.4 'PGPASSWORD=4md4lNET pg_dump -h localhost -U postgres -d amdalnet -c --if-exists --no-owner > ~/amdalnet.sql; PGPASSWORD=4md4lNET psql -h 103.172.205.4 -d amdalnet_bak -U postgres -f ~/amdalnet.sql'
  environment:
    name: staging
  only:
    - master
  tags:
    - amdalnet

deploy_cloud:
  stage: cloud
  script:
    - cd /var/www/amdalnet/
    - git reset --hard origin/master
    - git pull
    - composer install
    - composer dump-autoload
    - php artisan migrate
    - npm install
    - npm run production
    #- PGPASSWORD=4md4lNET pg_dump -h localhost -U postgres -d amdalnet -c --if-exists --no-owner > ~/amdalnet.sql
    #- PGPASSWORD=4md4lNET psql -h localhost -d amdalnet_bak -U postgres -f ~/amdalnet.sql
  only:
    - master
  tags:
    - cloud

deploy_prod:
  stage: production
  script:
    - cd /var/www/amdalnet/
    - git reset --hard origin/master
    - git pull
    - composer install
    - composer dump-autoload
    - php artisan migrate
    - npm install
    - npm run production
  only:
    - tags
  tags:
    - prod

deploy_api-dev_menlhk:
  stage: production
  script:
    - cd /var/www/amdalnet/
    - git reset --hard origin/master
    - git pull
    - composer install
    - composer dump-autoload
    - php artisan migrate
    - npm install
    - npm run production
  only:
    - master
  tags:
    - amdalnet-api-dev-menlhk

deploy_app-dev_menlhk:
  stage: production
  script:
    - cd /var/www/amdalnet/
    - git reset --hard origin/master
    - git pull
    - composer install
    - composer dump-autoload
    - php artisan migrate
    - npm install
    - npm run production
    #- echo "update app server"
    #- ssh ubuntu@192.168.102.33 -p 52222 'sudo -u www-data bash; cd /var/www/amdalnet; git reset --hard HEAD; git pull; composer install; composer dump-autoload; php artisan migrate; npm install; npm run production'
  only:
    - master
  tags:
    - amdalnet-app-dev-menlhk


deploy_api_menlhk:
  stage: production
  script:
    - cd /var/www/amdalnet/
    - git reset --hard origin/master
    - git pull
    - composer install
    - composer dump-autoload
    - php artisan migrate
    - npm install
    - npm run production
  only:
    - master
  tags:
    - amdalnet-api-menlhk

deploy_app_menlhk:
  stage: production
  script:
    - cd /var/www/amdalnet/
    - git reset --hard origin/master
    - git pull
    - composer install
    - composer dump-autoload
    - php artisan migrate
    - npm install
    - npm run production
    #- echo "update app server"
    #- ssh ubuntu@192.168.102.33 -p 52222 'sudo -u www-data bash; cd /var/www/amdalnet; git reset --hard HEAD; git pull; composer install; composer dump-autoload; php artisan migrate; npm install; npm run production'
  only:
    - master
  tags:
    - amdalnet-app-menlhk
