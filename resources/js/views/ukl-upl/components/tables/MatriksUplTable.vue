<template>
  <div class="app-container">
    <el-button
      :loading="loadingSubmit"
      type="success"
      size="small"
      icon="el-icon-check"
      style="margin-bottom: 10px;"
      @click="handleSaveForm"
    >
      Simpan Perubahan
    </el-button>
    <el-table
      v-loading="loading"
      :data="data"
      :span-method="arraySpanMethod"
      fit
      highlight-current-row
      :header-cell-style="{ background: '#6cc26f', color: 'white' }"
      style="width: 100%"
    >
      <el-table-column label="No." width="54px">
        <template slot-scope="scope">
          <div v-if="scope.row.is_stage">
            <b>{{ scope.row.project_stage_name }}</b>
          </div>
          <div v-if="!scope.row.is_stage">
            {{ scope.row.index }}.
          </div>
        </template>
      </el-table-column>
      <el-table-column label="Sumber Dampak">
        <template slot-scope="scope">
          <span v-if="!scope.row.is_stage">{{ scope.row.component_name }}</span>
        </template>
      </el-table-column>
      <el-table-column label="Jenis Dampak">
        <template slot-scope="scope">
          <span v-if="!scope.row.is_stage">{{ scope.row.change_type_name }} {{ scope.row.rona_awal_name }} akibat {{ scope.row.component_name }}</span>
        </template>
      </el-table-column>
      <el-table-column label="Besaran Dampak">
        <template slot-scope="scope">
          <span v-if="!scope.row.is_stage">{{ scope.row.unit }}</span>
        </template>
      </el-table-column>
      <el-table-column :key="splhKey" label="Standar Pemantauan Lingkungan Hidup">
        <el-table-column label="Bentuk">
          <template slot-scope="scope">
            <div v-if="!scope.row.is_stage">
              <div v-for="form in scope.row.env_monitor_plan.forms" :key="form.num">
                <el-tooltip class="item" effect="dark" placement="top-start">
                  <div slot="content">
                    {{ form.description }}
                  </div>
                  <el-button
                    type="default"
                    size="medium"
                    :style="formButtonStyle(form)"
                    @click="handleViewPlans(scope.row, form)"
                  >
                    <el-button
                      v-if="isFormulator"
                      type="danger"
                      size="mini"
                      icon="el-icon-close"
                      style="margin-left: 0px; margin-right: 10px;"
                      class="button-action-mini"
                      @click="handleDeleteForm(scope.$index, form.id, form.num)"
                    />
                    <span>{{ trimForm(form.description) }}</span>
                    <!-- <el-button
                      v-if="isFormulator"
                      type="default"
                      size="mini"
                      class="pull-right button-action-mini"
                      icon="el-icon-edit"
                      @click="handleEditComponent(comp.id)"
                    /> -->
                  </el-button>
                </el-tooltip>
              </div>
              <el-input v-model="newForm" placeholder="Bentuk Pemantauan..." type="textarea" :rows="2" />
              <el-button v-if="isFormulator" icon="el-icon-plus" circle style="margin-top:1em;display:block;" round @click="handleAddForm(scope.$index)" />
              <small
                v-if="checkError(scope.row.env_monitor_plan.errors, 'forms')"
                style="color: #f56c6c; display: block"
              >
                Silahkan Isi Kolom Bentuk Pengelolaan
              </small>
            </div>
          </template>
        </el-table-column>
        <el-table-column label="Lokasi">
          <template slot-scope="scope">
            <div v-if="!scope.row.is_stage">
              <div v-for="location in scope.row.env_monitor_plan.locations" :key="location.num">
                <el-tooltip class="item" effect="dark" placement="top-start">
                  <div slot="content">
                    {{ location.description }}
                  </div>
                  <el-button
                    type="default"
                    size="medium"
                    :style="formButtonStyle(location)"
                    @click="handleViewPlans(scope.row, location)"
                  >
                    <el-button
                      v-if="isFormulator"
                      type="danger"
                      size="mini"
                      icon="el-icon-close"
                      style="margin-left: 0px; margin-right: 10px;"
                      class="button-action-mini"
                      @click="handleDeleteLocation(scope.$index, location.id, location.num)"
                    />
                    <!-- <span>{{ trimForm(form.description) }}</span> -->
                    <span>{{ trimForm(location.description) }}</span>
                    <!-- <el-button
                      v-if="isFormulator"
                      type="default"
                      size="mini"
                      class="pull-right button-action-mini"
                      icon="el-icon-edit"
                      @click="handleEditComponent(comp.id)"
                    /> -->
                  </el-button>
                </el-tooltip>
              </div>
              <el-input v-model="newLocation" placeholder="Lokasi..." type="textarea" :rows="2" />
              <el-button v-if="isFormulator" icon="el-icon-plus" circle style="margin-top:1em;display:block;" round @click="handleAddLocation(scope.$index)" />
              <small
                v-if="checkError(scope.row.env_monitor_plan.errors, 'locations')"
                style="color: #f56c6c; display: block"
              >
                Silahkan Isi Kolom Lokasi
              </small>
            </div>
          </template>
        </el-table-column>
        <el-table-column label="Periode">
          <template slot-scope="scope">
            <div v-if="!scope.row.is_stage">
              <el-input-number
                v-model="scope.row.env_monitor_plan.period_number"
                :min="0"
                :max="100"
                :disabled="!isFormulator"
                size="mini"
              />
              <small
                v-if="checkError(scope.row.env_monitor_plan.errors, 'period_number')"
                style="color: #f56c6c; display: block"
              >
                Silahkan Isi Kolom Nomor Periode
              </small>
              x
              <el-select
                v-model="scope.row.env_monitor_plan.period_description"
                placeholder="Pilihan"
                :disabled="!isFormulator"
              >
                <el-option
                  v-for="item in periode"
                  :key="item.value"
                  :label="item.label"
                  :value="item.value"
                />
              </el-select>
              <small
                v-if="checkError(scope.row.env_monitor_plan.errors, 'period_description')"
                style="color: #f56c6c; display: block"
              >
                Silahkan Isi Kolom Deskripsi Periode
              </small>
            </div>
          </template>
        </el-table-column>
      </el-table-column>
      <el-table-column :key="iplhKey" label="Institusi Pemantauan Lingkungan Hidup">
        <template slot-scope="scope">
          <div v-if="!scope.row.is_stage">
            <div>Pelaksana: <el-input v-model="scope.row.env_monitor_plan.executor" /></div>
            <small
              v-if="checkError(scope.row.env_monitor_plan.errors, 'executor')"
              style="color: #f56c6c; display: block"
            >
              Silahkan Isi Kolom Pelaksana
            </small>
            <div>Pengawas: <el-input v-model="scope.row.env_monitor_plan.supervisor" /></div>
            <small
              v-if="checkError(scope.row.env_monitor_plan.errors, 'supervisor')"
              style="color: #f56c6c; display: block"
            >
              Silahkan Isi Kolom Pengawas
            </small>
            <div>Penerima Laporan: <el-input v-model="scope.row.env_monitor_plan.report_recipient" /></div>
            <small
              v-if="checkError(scope.row.env_monitor_plan.errors, 'report_recipient')"
              style="color: #f56c6c; display: block"
            >
              Silahkan Isi Kolom Penerima Laporan
            </small>
          </div>
        </template>
      </el-table-column>
      <el-table-column :key="descKey" label="Keterangan">
        <template slot-scope="scope">
          <div v-if="!scope.row.is_stage">
            <el-input
              v-model="scope.row.env_monitor_plan.description"
              type="textarea"
              :rows="4"
            />
            <small
              v-if="checkError(scope.row.env_monitor_plan.errors, 'description')"
              style="color: #f56c6c; display: block"
            >
              Silahkan Isi Kolom Keterangan
            </small>
          </div>
        </template>
      </el-table-column>
    </el-table>
  </div>
</template>

<script>
import Resource from '@/api/resource';
import axios from 'axios';
const impactIdtResource = new Resource('impact-identifications');
// const envMonitorPlanResource = new Resource('env-monitor-plans');

export default {
  name: 'MatriksUplTable',
  data() {
    return {
      idProject: 0,
      currentPlanIdx: 0,
      newEnvMonitorPlan: {},
      data: [],
      deletedForm: [],
      deletedLocation: [],
      newForm: null,
      newLocation: null,
      periode: [
        {
          label: 'per Hari',
          value: 'per Hari',
        },
        {
          label: 'per Minggu',
          value: 'per Minggu',
        },
        {
          label: 'per Bulan',
          value: 'per Bulan',
        },
        {
          label: 'per Tahun',
          value: 'per Tahun',
        },
      ],
      loading: true,
      splhKey: 1,
      iplhKey: 1,
      descKey: 1,
      loadingSubmit: false,
    };
  },
  computed: {
    isFormulator() {
      return this.$store.getters.roles.includes('formulator');
    },
  },
  mounted() {
    this.getData();
  },
  methods: {
    reloadPlanData() {
      this.splhKey = this.splhKey + 1;
      this.iplhKey = this.iplhKey + 1;
      this.descKey = this.descKey + 1;
    },
    async getData() {
      this.loading = true;
      this.idProject = parseInt(this.$route.params && this.$route.params.id);
      await axios.get('api/matriks-ukl-upl/table-upl/' + this.idProject)
        .then(response => {
          this.data = response.data;
          this.loading = false;
        });
    },
    trimForm(form) {
      return form.length < 10 ? form : form.substring(0, 9) + '...';
    },
    formButtonStyle(plan) {
      if (plan.is_selected) {
        return { backgroundColor: '#facd7a', color: '#000000', marginBottom: '5px' };
      } else {
        return { backgroundColor: '#ffffff', color: '#099C4B', marginBottom: '5px' };
      }
    },
    // handleViewPlans(imp, plan) {
    //   imp.env_monitor_plan.forEach((p) => {
    //     p.is_selected = false;
    //   });
    //   plan.is_selected = true;
    //   this.reloadPlanData();
    // },
    arraySpanMethod({ row, column, rowIndex, columnIndex }) {
      if (row.is_stage) {
        return [1, 9];
      }
      return [1, 1];
    },
    handleSaveForm() {
      let errors = 0;
      const data = [...this.data];
      this.data = data.map(x => {
        if (x.env_monitor_plan) {
          const newEnvMonitorPlan = x.env_monitor_plan.map(y => {
            y.errors = {};
            if (!y.description || !y.executor || !y.form || !y.location || !y.period_number || !y.period_description || !y.report_recipient || !y.supervisor) {
              errors++;
            }
            y.errors.description = Boolean(!y.description);
            y.errors.executor = Boolean(!y.executor);
            y.errors.form = Boolean(!y.form);
            y.errors.location = Boolean(!y.location);
            y.errors.period_number = Boolean(!y.period_number);
            y.errors.period_description = Boolean(!y.period_description);
            y.errors.report_recipient = Boolean(!y.report_recipient);
            y.errors.supervisor = Boolean(!y.supervisor);
            return y;
          });
          x.env_monitor_plan = newEnvMonitorPlan;
          return x;
        }
        return x;
      });
      if (errors > 0) {
        this.$alert(
          'Silahkan lengkapi data matriks UPL',
          {
            confirmButtonText: 'OK',
          }
        );
      } else {
        impactIdtResource
          .store({
            env_monitor_plan_data: this.data,
          })
          .then((response) => {
            if (response.code === 200) {
              this.$message({
                message: 'Matriks UPL berhasil disimpan',
                type: 'success',
                duration: 5 * 1000,
              });
            // this.$emit('handleCheckProjectMarking');
            }
          })
          .catch((err) => {
            this.$message({
              message: err.response.data.message,
              type: 'error',
              duration: 5 * 1000,
            });
          });
      }
    },
    addPlanToImpact(idImp, plan) {
      const idx = this.data.findIndex(imp => imp.id === idImp);
      if (idx >= 0) {
        this.data[idx].env_monitor_plan.push(plan);
      }
    },
    removePlanFromImpact(idImp, idPlan) {
      const idx = this.data.findIndex(imp => imp.id === idImp);
      if (idx >= 0) {
        const idxPlan = this.data[idx].env_monitor_plan.findIndex(p => p.id === idPlan);
        if (idxPlan >= 0) {
          this.data[idx].env_monitor_plan.splice(idxPlan, 1);
        }
      }
    },
    handleAddPlan(idImp) {
      // if (this.newEnvMonitorPlan[idImp] === undefined ||
      //   this.newEnvMonitorPlan[idImp] === null ||
      //   this.newEnvMonitorPlan[idImp].replace(/\s+/g, '').trim() === '') {
      //   this.$message({
      //     message: 'Bentuk Pemantauan tidak boleh kosong',
      //     type: 'error',
      //     duration: 5 * 1000,
      //   });
      // } else {
      //   envMonitorPlanResource
      //     .store({
      //       id_impact_identifications: idImp,
      //       form: this.newEnvMonitorPlan[idImp],
      //     })
      //     .then((response) => {
      //       if (response.code === 200) {
      //         this.$message({
      //           message: 'Bentuk UPL berhasil disimpan',
      //           type: 'success',
      //           duration: 5 * 1000,
      //         });
      //         // add new env_monitor_plan to this.data
      //         this.addPlanToImpact(parseInt(idImp), response.data);
      //         this.newEnvMonitorPlan[idImp] = '';
      //       }
      //     })
      //     .catch((err) => {
      //       this.$message({
      //         message: err.response.data.message,
      //         type: 'error',
      //         duration: 5 * 1000,
      //       });
      //     });
      // }
    },
    handleDeletePlan(idImp, id) {
      // envMonitorPlanResource
      //   .destroy(id)
      //   .then((response) => {
      //     if (response.code === 200) {
      //       this.$message({
      //         message: 'Bentuk UPL berhasil dihapus',
      //         type: 'success',
      //         duration: 5 * 1000,
      //       });
      //       // remove env_monitor_plan from this.data
      //       this.removePlanFromImpact(parseInt(idImp), parseInt(id));
      //     }
      //   })
      //   .catch((err) => {
      //     this.$message({
      //       message: err.response.data.message,
      //       type: 'error',
      //       duration: 5 * 1000,
      //     });
      //   });
    },
    checkError(errors, key) {
      if (errors) {
        return errors[key];
      }

      return false;
    },
  },
};
</script>
<style scoped>

.button-action-mini {
  margin-left: 20px;
  padding: 1px 1px;
}

.button-medium {
  padding: 5px 5px 5px 5px;
}

.button-comp-active {
  background-color: #facd7a;
}

.button-comp-inactive {
  background-color: white;
}

</style>
